{% extends "base.html" %}
{% block content %}
<h1>Join Group: {{ request.args.get('group_name') }}</h1>
<form action="{{ url_for('join_group') }}" method="post" class="mt-5">
    <input type="hidden" name="group_name" value="{{ request.args.get('group_name') }}">
    <div class="form-group">
        <label for="your_name">Your Name</label>
        <input type="text" name="your_name" class="form-control" required>
    </div>
    <div class="form-group">
        <label for="location">Location</label>
        <div class="input-group">
            <input type="text" name="location" id="location" class="form-control" placeholder="Enter location or use the icon">
            <div class="input-group-append">
                <button type="button" class="btn btn-outline-secondary" onclick="getLocation()">
                    <i class="fas fa-map-marker-alt"></i>
                </button>
            </div>
        </div>
        <small id="location-help" class="form-text text-muted">Click the icon to use your current location.</small>
    </div>
    <button type="submit" class="btn btn-primary">Join</button>
    <button type="button" class="btn btn-secondary" onclick="window.history.back()">Back</button>
</form>

<script>
    const apiKey = '{{ api_key }}';
    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition, showError);
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    }

    function showPosition(position) {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        const locationField = document.getElementById('location');
        const geocodeUrl = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lon}&key=${apiKey}`;

        fetch(geocodeUrl)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'OK') {
                    const results = data.results[0].address_components;
                    console.log(results)
                    let city = '';
                    for (let i = 0; i < results.length; i++) {
                        if (results[i].types.includes('locality')) {
                            city = results[i].long_name;
                            break;
                        }
                    }
                    locationField.value = city;
                } else {
                    alert('Unable to retrieve your location. Please enter it manually.');
                }
            })
            .catch(error => {
                console.error('Error fetching location:', error);
                alert('Unable to retrieve your location. Please enter it manually.');
            });
    }

    function showError(error) {
        switch(error.code) {
            case error.PERMISSION_DENIED:
                alert("User denied the request for Geolocation.");
                break;
            case error.POSITION_UNAVAILABLE:
                alert("Location information is unavailable.");
                break;
            case error.TIMEOUT:
                alert("The request to get user location timed out.");
                break;
            case error.UNKNOWN_ERROR:
                alert("An unknown error occurred.");
                break;
        }
    }
</script>
{% endblock %}
