{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
    <h3>{{ session['your_name'] }}'s Vote</h3>
    <h4 class="mt-3">Now vote for a winner!</h4>
    <div class="form-group">
        <label for="filter">Filter by:</label>
        <select class="form-select" id="filter" onchange="applyFilter()">
            <option value="nearest">Nearest to you</option>
            <option value="seats">Seat availability</option>
            <option value="rating">Rating</option>
        </select>
    </div>
    <form action="{{ url_for('vote_winner') }}" method="post">
        <div class="form-group mt-3">
            <div class="row" id="restaurant-list">
                <div class="col-md-12">
                    <div class="card mb-4 shadow-sm">
                        <div class="card-body">
                            <img src="{{ url_for('static', filename=selected_restaurant['image']) }}" class="card-img-top" alt="Restaurant Image" style="width: 50px; height: 50px; object-fit: cover;">
                            <span class="badge {{ 'bg-warning' if selected_restaurant['seats'] == 'Limited seating' else 'bg-success' }}">{{ selected_restaurant['seats'] }}</span>
                            <h5 class="card-title">{{ selected_restaurant.name }} ({{ selected_restaurant['distance'] }}, {{ selected_restaurant['rating'] }} stars)</h5>
                            <span class="badge bg-primary">{{ selected_restaurant['price'] }}</span>
                            <span>{{ selected_restaurant['cuisine'] }}</span>
                            <button type="button" class="btn btn-outline-primary view-details-btn" data-bs-toggle="modal" data-bs-target="#restaurantModalSelected">View Details</button>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-primary" onclick="selectPreference('{{ selected_restaurant.name }}', 1)">1</button>
                                <button type="button" class="btn btn-secondary" onclick="selectPreference('{{ selected_restaurant.name }}', 2)">2</button>
                            </div>
                        </div>
                    </div>
                    <span class="discount-details" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ selected_restaurant['discount'] }}">Discount Details</span>
                </div>

                {% for restaurant in other_restaurants %}
                <div class="col-md-12">
                    <div class="card mb-4 shadow-sm">
                        <div class="card-body">
                            <img src="{{ url_for('static', filename=restaurant['image']) }}" class="card-img-top" alt="Restaurant Image" style="width: 50px; height: 50px; object-fit: cover;">
                            <span class="badge {{ 'bg-warning' if restaurant['seats'] == 'Limited seating' else 'bg-success' }}">{{ restaurant['seats'] }}</span>
                            <h5 class="card-title">{{ restaurant.name }} ({{ restaurant['distance'] }}, {{ restaurant['rating'] }} stars)</h5>
                            <span class="badge bg-primary">{{ restaurant['price'] }}</span>
                            <span>{{ restaurant['cuisine'] }}</span>
                            <button type="button" class="btn btn-outline-primary view-details-btn" data-bs-toggle="modal" data-bs-target="#restaurantModal{{ loop.index }}">View Details</button>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-primary" onclick="selectPreference('{{ restaurant.name }}', 1)">1</button>
                                <button type="button" class="btn btn-secondary" onclick="selectPreference('{{ restaurant.name }}', 2)">2</button>
                            </div>
                        </div>
                    </div>
                    <span class="discount-details" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ restaurant['discount'] }}">Discount Details</span>
                </div>
                {% endfor %}
            </div>
        </div>
        <input type="hidden" name="first_preference" id="first_preference_input">
        <input type="hidden" name="second_preference" id="second_preference_input">
        <button type="submit" class="btn btn-primary mt-3">Vote</button>
    </form>
    <button type="button" class="btn btn-secondary mt-3" onclick="window.history.back()">&#x2190; Back</button>
</div>

<!-- Modal for selected restaurant -->
<div class="modal fade" id="restaurantModalSelected" tabindex="-1" aria-labelledby="restaurantModalLabelSelected" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="restaurantModalLabelSelected">
                    <span class="badge {{ 'bg-warning' if selected_restaurant['seats'] == 'Limited seating' else 'bg-success' }}">{{ selected_restaurant['seats'] }}</span>
                    {{ selected_restaurant.name }}
                    <span class="badge bg-primary">{{ selected_restaurant['price'] }}</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <img src="{{ url_for('static', filename=selected_restaurant['image']) }}" alt="{{ selected_restaurant.name }}" class="img-fluid">
                <p>{{ selected_restaurant['details'] }}</p>
                <h6>See what people think...</h6>
                <div class="review">
                    {% for review in selected_restaurant['reviews'] %}
                    <p><strong>{{ review['name'] }}:</strong> {{ review['comment'] }}</p>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">&#x2190; Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Modals for other restaurants -->
{% for restaurant in other_restaurants %}
<div class="modal fade" id="restaurantModal{{ loop.index }}" tabindex="-1" aria-labelledby="restaurantModalLabel{{ loop.index }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="restaurantModalLabel{{ loop.index }}">
                    <span class="badge {{ 'bg-warning' if restaurant['seats'] == 'Limited seating' else 'bg-success' }}">{{ restaurant['seats'] }}</span>
                    {{ restaurant.name }}
                    <span class="badge bg-primary">{{ restaurant['price'] }}</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <img src="{{ url_for('static', filename=restaurant['image']) }}" alt="{{ restaurant.name }}" class="img-fluid">
                <p>{{ restaurant['details'] }}</p>
                <h6>See what people think...</h6>
                <div class="review">
                    {% for review in restaurant['reviews'] %}
                    <p><strong>{{ review['name'] }}:</strong> {{ review['comment'] }}</p>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">&#x2190; Close</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<script>
let selectedFirst = null;
let selectedSecond = null;

function selectPreference(restaurantName, preference) {
    if (preference === 1) {
        selectedFirst = restaurantName;
        document.getElementById('first_preference_input').value = restaurantName;
    } else {
        selectedSecond = restaurantName;
        document.getElementById('second_preference_input').value = restaurantName;
    }

    // Clear previous selections
    document.querySelectorAll('.btn-primary').forEach(button => button.classList.remove('active'));
    document.querySelectorAll('.btn-secondary').forEach(button => button.classList.remove('active'));

    // Highlight current selection
    if (selectedFirst) {
        document.querySelectorAll(`button[onclick="selectPreference('${selectedFirst}', 1)"]`).forEach(button => button.classList.add('active'));
    }
    if (selectedSecond) {
        document.querySelectorAll(`button[onclick="selectPreference('${selectedSecond}', 2)"]`).forEach(button => button.classList.add('active'));
    }
}

function applyFilter() {
    const filter = document.getElementById('filter').value;
    let sortedRestaurants = [];
    if (filter === 'nearest') {
        sortedRestaurants = [...document.querySelectorAll('#restaurant-list .col-md-12')].sort((a, b) => {
            const distanceA = parseFloat(a.querySelector('.card-title').textContent.split(' ')[1]);
            const distanceB = parseFloat(b.querySelector('.card-title').textContent.split(' ')[1]);
            return distanceA - distanceB;
        });
    } else if (filter === 'seats') {
        sortedRestaurants = [...document.querySelectorAll('#restaurant-list .col-md-12')].sort((a, b) => {
            const seatsA = a.querySelector('.badge').classList.contains('bg-warning') ? 0 : 1;
            const seatsB = b.querySelector('.badge').classList.contains('bg-warning') ? 0 : 1;
            return seatsB - seatsA;
        });
    } else if (filter === 'rating') {
        sortedRestaurants = [...document.querySelectorAll('#restaurant-list .col-md-12')].sort((a, b) => {
            const ratingA = parseFloat(a.querySelector('.card-title').textContent.split(' ')[3]);
            const ratingB = parseFloat(b.querySelector('.card-title').textContent.split(' ')[3]);
            return ratingB - ratingA;
        });
    }

    const restaurantList = document.getElementById('restaurant-list');
    restaurantList.innerHTML = '';
    sortedRestaurants.forEach(restaurant => restaurantList.appendChild(restaurant));
}

document.addEventListener('DOMContentLoaded', function () {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });
});
</script>
{% endblock %}
